# -----------------------------
# Stage 1: Base Image
FROM python:3.10-slim AS base
WORKDIR /app
# Install system deps needed by ocr (poppler) and retriever (postgres)
RUN apt-get update && \
    apt-get install -y libpq-dev gcc poppler-utils && \
    rm -rf /var/lib/apt/lists/*

# -----------------------------
# Stage 2a: OCR Dependencies
FROM base AS deps-ocr
WORKDIR /app
COPY backend/src/services/requirements-ocr.txt .
RUN pip install --no-cache-dir -r requirements-ocr.txt

# -----------------------------
# Stage 2b: LLM Dependencies
FROM base AS deps-llm
WORKDIR /app
COPY backend/src/services/requirements-llm.txt .
RUN pip install --no-cache-dir -r requirements-llm.txt

# -----------------------------
# Stage 2c: Retriever Dependencies
FROM base AS deps-retriever
WORKDIR /app
COPY backend/src/services/requirements-retriever.txt .
RUN pip install --no-cache-dir -r requirements-retriever.txt

# -----------------------------
# Stage 3: Retriever Service
FROM base AS retriever
WORKDIR /app
# Copy ONLY the retriever dependencies
COPY --from=deps-retriever /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY backend/src/services/retrieverService.py .
EXPOSE 9000
CMD ["python", "retrieverService.py"]

# -----------------------------
# Stage 4: LLM Service
FROM base AS llm
WORKDIR /app
# Copy ONLY the llm dependencies
COPY --from=deps-llm /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY backend/src/services/llmService.py .
EXPOSE 8000
CMD ["python", "llmService.py"]

# -----------------------------
# Stage 5: OCR Service
FROM base AS ocr
WORKDIR /app
# Copy ONLY the ocr dependencies
COPY --from=deps-ocr /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY backend/src/services/ocrService.py .
EXPOSE 7000
CMD ["python", "ocrService.py"]